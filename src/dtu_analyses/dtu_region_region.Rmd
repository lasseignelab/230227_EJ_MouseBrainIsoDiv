---
title: 'DTU Analysis: Pairwise Brain Regions'
author: "Emma Jones"
date: "2023-02-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Differential Transcript Usage (DTU) Analysis in Mouse Brain lrRNA-Seq Data

#### Load in packages

```{r load packages}
library(tidyverse)
library(IsoformSwitchAnalyzeR)
library(ComplexHeatmap)
library(viridis)
library(org.Mm.eg.db)
library(gprofiler2)
library(styler)
library(lintr)
library(here)
```

#### Load in data

Next, I want to read in data and get tpm values. Since I'll be doing this for all 3 analyses, I made it an R script that can be sourced. I will also source all of the functions I wrote.

```{r read in data and get tpm values}
source("calculate_cpm.R", local = knitr::knit_global())
source("functions.R", local = knitr::knit_global())
```

## Begin DTU analysis for pairwise brain region comparisons

The package requires a design matrix in specific format.

```{r make design matrix}
exp_design <- data.frame(
  sampleID = sample_collection_metadata$sample_id,
  condition = sample_collection_metadata$tissue
)
```

Make a switchlist, which is an object required for running isoformswitchanalyzer.

```{r add fasta of transcripts to object}
cpm_switchlist <- importRdata(
  isoformCountMatrix = merged_counts_iso,
  isoformRepExpression = cpm_iso,
  designMatrix = exp_design,
  isoformExonAnnoation = here(
    "data", "nextflow", "results", "bambu",
    "extended_annotations.gtf"
  ),
  isoformNtFasta = here("data", "gffread", "isoform_sequences.fa"),
  showProgress = FALSE
)
```

Now, I can run DEXSeq. Because my data includes counts of less than 1, I still want to include them in my analysis.

```{r run dexseq}
# filter data and disabling gene expression cutoff
cpm_switchlist <- preFilter(cpm_switchlist, geneExpressionCutoff = NULL)
# now run DEXSeq
cpm_switchlist_dexseq <- isoformSwitchTestDEXSeq(
  switchAnalyzeRlist = cpm_switchlist,
  reduceToSwitchingGenes = TRUE
)

extractSwitchSummary(cpm_switchlist_dexseq)
# save object for further analyses
saveRDS(cpm_switchlist_dexseq, here(
  "data", "switchlist_objects",
  "region_region_switchlist_analyzed.Rds"
))
```

### Make UpSet Plots

The goal of these plots is to show overlap between significantly differentially used isoforms across conditions.
First, I need to get significant genes and split them out by brain region.

```{r make upset plots for overlap by brain region}
# make vector of brain regions
all_regions <- c("cerebellum", "cortex", "hippocampus", "striatum")
# first, get significant isoform switches
sig_isoform_features <- cpm_switchlist_dexseq$isoformFeatures
sig_isoform_features <- dplyr::filter(
  sig_isoform_features, abs(dIF) > 0.1 & isoform_switch_q_value < 0.05
)

# pull just genes
sig_isoform_genes <- sig_isoform_features %>%
  distinct(gene_id, condition_1, condition_2, .keep_all = TRUE)

# use function to filter genes in condition 1 OR condition 2
lapply(all_regions, filter_genes_or)

# make into list
sig_isoform_gene_list <- list(
  cerebellum = sig_isoform_genes_cere,
  cortex = sig_isoform_genes_cort,
  hippocampus = sig_isoform_genes_hipp,
  striatum = sig_isoform_genes_stri
)
```

I also can indicate not just overlapping, but specifically which genes are DTU and have overlap?

I want to get a list of genes for each comparison.

```{r get list of genes for each comparison}
# make vector of comparisons
comparison_arg_1 <- c(rep("cerebellum", 3), rep("cortex", 2), "hippocampus")
comparison_arg_2 <- c(
  "cortex", "hippocampus", "striatum", "hippocampus",
  "striatum", "striatum"
)
# use function to get list of genes for each comparison
mapply(filter_genes_comp, comparison_arg_1, comparison_arg_2)
```

Once I have these, I can combine them into a list for plotting.

```{r setup overlap of comparisons}
# make into list
sig_overlap_list <- list(
  cere_cort = sig_isoform_genes_cere_cort,
  cere_hipp = sig_isoform_genes_cere_hipp,
  cere_stri = sig_isoform_genes_cere_stri,
  cort_hipp = sig_isoform_genes_cort_hipp,
  cort_stri = sig_isoform_genes_cort_stri,
  hipp_stri = sig_isoform_genes_hipp_stri
)
```

Now that the data is prepped, I can plot a complexheatmap UpSet plot. Here, color indicates degree of overlap being examined.

```{r make complexheatmap UpSet plot for all comparisons}
# make UpSet plot (ComplexHeatmap)
# create matrix
sig_overlap_list_mat <- list_to_matrix(sig_overlap_list)

# generate combination matrix
sig_overlap_list_comb_mat <- make_comb_mat(sig_overlap_list_mat)

# make UpSet plot (ComplexHeatmap)
UpSet(sig_overlap_list_comb_mat,
  comb_order = order(-comb_size(sig_overlap_list_comb_mat)),
  comb_col = viridis(6)[comb_degree(sig_overlap_list_comb_mat)],
  top_annotation = upset_top_annotation(sig_overlap_list_comb_mat,
    add_numbers = TRUE
  ),
  right_annotation = upset_right_annotation(sig_overlap_list_comb_mat,
    add_numbers = TRUE
  )
)
```

I think this is the most informative use of an UpSet plot. There are a lot of overlap that only have 1 gene in common, so maybe later I want to only include the comparisons with the most overlap (like top 10).

### Volcano Plots

Making volcano plots is a classic way to show the relationship between fold changes and p values. I will make some here with the differential isoform fraction, instead of the more common differential expression (log2foldchange) seen in DE experiments.

```{r volcano plot}
# use function on all comparisons
mapply(create_volcano_plot_comp, comparison_arg_1, comparison_arg_2)
```

## GO Anlaysis of Gene Sets

The nest step of doing DTU is a GO analysis with my gene sets. I am going to use the package gprofiler2. I guess I want to do GO for every comparison list and then see if they have similar processes.

I need to get the correct number of background genes, so this is all genes that were tested for significance, whether significant or not.

```{r get correct list of background genes}
bg_genes <- unique(cpm_switchlist$isoformFeatures$gene_id)
bg_genes <- str_extract(bg_genes, "ENSMUSG...........")
```

Now I can run gprofiler.

```{r gprofiler2}
run_plot_gprofiler(sig_isoform_genes_cere_cort)
run_plot_gprofiler(sig_isoform_genes_cere_hipp)
run_plot_gprofiler(sig_isoform_genes_cere_stri)
run_plot_gprofiler(sig_isoform_genes_cort_hipp) # may need to skip
run_plot_gprofiler(sig_isoform_genes_cort_stri)
run_plot_gprofiler(sig_isoform_genes_hipp_stri)
```

There are not a lot of results, and most things are not significant. This amount of GO is not really seeming beneficial to me, even with hundreds of DTU genes. 

### Final thoughts

Overall, in this analysis I show that the largest differences in DTU are across cerebellum and the other brain regions.

#### Clean up script

```{r tidy script}
style_file("dtu_region_region.Rmd")
lint("dtu_region_region.Rmd",
  linters = linters_with_defaults(
    object_length_linter = NULL,
    object_name_linter = NULL,
    object_usage_linter = NULL
  )
)
```

#### Software versions

```{r versions}
sessionInfo()
```
