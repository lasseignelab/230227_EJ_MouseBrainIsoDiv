---
title: "DTU Analysis: Brain Region vs All"
author: "Emma Jones"
date: "2023-02-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Differential Transcript Usage (DTU) Analysis by Region in Mouse Brain lrRNA-Seq Data

#### Load in packages

```{r load packages}
library(tidyverse)
library(IsoformSwitchAnalyzeR)
library(ComplexHeatmap)
library(viridis)
library(org.Mm.eg.db)
library(styler)
library(lintr)
library(here)
```

#### Load in data

Next, I want to read in data and get cpm values. Since I'll be doing this for all 3 analyses, I made it an R script that can be sourced.

```{r read in data and get cpm values}
source("calculate_cpm.R", local = knitr::knit_global())
source("functions.R", local = knitr::knit_global())
```

## DTU for one region versus all other regions

First, I need to update my design matrix because I need to make pairwise comparisons for each region versus all other regions. Then, I can make a new switchAnalyzeRlist object. This is required to run an isoform switch test with DEXSeq. I've made this into a function to make it faster.

Once switchAnalyzeRlists are made, you can run the DEXSeq isoform switch test. You also need to prefilter the data before running the test, but I added all that to the my function so all it needs is to run.

```{r make region vs all objects}
# make vector of brain regions
all_regions <- c("cerebellum", "cortex", "hippocampus", "striatum")
# run function on all brain regions
lapply(all_regions, make_switchlist_run_dexseq)
```

These switchlists are fine, but I'm going to write a function for adding gene names to make downstream analysis better and more interpretable. This can be added to the last function

```{r add gene names}
# run function on all brain regions
lapply(all_regions, get_gene_symbols)
```

### Make plots for tissue:all DTU

Now that those objects are saved, I need to make plots for them. To do that, I want to extract the significant genes.
I will start with UpSet plots (using ComplexHeatmap for color) to show overlap of significant genes.

```{r extract sigificant tissue:all genes}
# get significant genes
get_sig_genes(cerebellum_switchlist_analyzed)
get_sig_genes(cortex_switchlist_analyzed)
get_sig_genes(hippocampus_switchlist_analyzed)
get_sig_genes(striatum_switchlist_analyzed)

# make all into list
all_gene_list <- list(
  cerebellum = cere_sig_genes,
  cortex = cort_sig_genes,
  hippocampus = hipp_sig_genes,
  striatum = stri_sig_genes
)
```

Now, with the list created I can create a ComplexHeatmap UpSet plot.

#### Make UpSet plots

```{r complexheatmap tissue:all UpSet genes}
# make UpSet plot (ComplexHeatmap)
# create matrix
all_gene_list_mat <- list_to_matrix(all_gene_list)

# generate combination matrix
all_gene_list_comb_mat <- make_comb_mat(all_gene_list_mat)

# make UpSet plot (ComplexHeatmap)
UpSet(all_gene_list_comb_mat,
  pt_size = unit(3, "mm"),
  comb_col = viridis(4)[comb_degree(all_gene_list_comb_mat)]
)

upset_gene <- UpSet(all_gene_list_comb_mat,
  comb_order = order(-comb_size(all_gene_list_comb_mat)),
  comb_col = viridis(4)[comb_degree(all_gene_list_comb_mat)],
  top_annotation = upset_top_annotation(
    all_gene_list_comb_mat,
    add_numbers = TRUE
  ),
  right_annotation = upset_right_annotation(
    all_gene_list_comb_mat,
    add_numbers = TRUE
  )
)

draw(upset_gene, column_title = "Overlap of DTU genes by brain region")
```

Cerebellum has most unique genes overall, but what happens when we extend this to isoforms?

```{r extract sigificant tissue:all isoforms}
# cerebellum isoforms
cere_sig_isoforms <- unique(cere_sig_features$isoform_id)

# cortex isoforms
ctx_sig_isoforms <- unique(ctx_sig_features$isoform_id)

# hippocampus isoforms
hip_sig_isoforms <- unique(hip_sig_features$isoform_id)

# striatum isoforms
stm_sig_isoforms <- unique(stm_sig_features$isoform_id)

# make all into list
all_isoform_list <- list(
  cerebellum = cere_sig_isoforms,
  cortex = ctx_sig_isoforms,
  hippocampus = hip_sig_isoforms,
  striatum = stm_sig_isoforms
)
```

Now list is made, I can make combination matrix and plot using complexheatmap

```{r plot complexheatmap tissue:all UpSet isoforms}
# make matrix
all_isoform_list_mat <- list_to_matrix(all_isoform_list)

# create combination matrix
all_isoform_list_comb_mat <- make_comb_mat(all_isoform_list_mat)

# make UpSet plot (ComplexHeatmap)
upset_isoform <- UpSet(
  all_isoform_list_comb_mat,
  comb_order = order(-comb_size(all_isoform_list_comb_mat)),
  comb_col = viridis(4)[comb_degree(all_isoform_list_comb_mat)],
  top_annotation = upset_top_annotation(all_isoform_list_comb_mat,
    add_numbers = TRUE
  ),
  right_annotation = upset_right_annotation(all_isoform_list_comb_mat,
    add_numbers = TRUE
  )
)

draw(upset_isoform, column_title = "Overlap of DTU isoforms by brain region")
```

#### Make volcano plots

I also want to make volcano plots to visualize this.

```{r make volcano plots for region v others}
# plot
create_volcano_plot_region(cerebellum_switchlist_analyzed)
create_volcano_plot_region(cortex_switchlist_analyzed)
create_volcano_plot_region(hippocampus_switchlist_analyzed)
create_volcano_plot_region(striatum_switchlist_analyzed)
```

#### Clean up script

```{r tidy script}
style_file("dtu_region_others.Rmd")
lint("dtu_region_others.Rmd")
```

#### Software versions

```{r versions}
sessionInfo()
```
