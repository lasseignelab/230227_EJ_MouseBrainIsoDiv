---
title: "PCA Outlier Analysis"
author: "Emma Jones"
date: "2023-03-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Run PCA for Exploratory Data Analysis

Before performing DTU analysis, we want to ensure data is good quality. So, we will do some exploratory data analysis including principal component analysis to see what is influencing gene expression.

#### Load in packages

```{r load packages}
library(tidyverse)
library(styler)
library(lintr)
library(here)
```

#### Load in data

Next, I want to read in data and get cpm values. Since I'll be doing this for all 3 analyses, I made it an R script that can be sourced.

```{r read in data and get cpm values}
source("calculate_cpm.R", local = knitr::knit_global())
```

### Run PCA

```{r run pca}
cpm_drop <- cpm[which(apply(cpm, 1, var) != 0), ] # drop rows with var = 0

pca_scaled <- prcomp(t(cpm_drop), scale = TRUE)

pca_metadata <- as_tibble(pca_scaled$x)
pca_metadata$sample_id <- rownames(pca_scaled$x)
pca_metadata <- left_join(pca_metadata, sample_collection_metadata)

var_explained <- pca_scaled$sdev^2 / sum(pca_scaled$sdev^2)
var_explained[1:5]
```

### Plot PCA

Now that the PCA has been run, we can plot. The plots can be colored by different aspects to see what is driving the principal components.

```{r plot PCA}
# make function, color is x and shape is y
plot_pca <- function(x, y) {
  pca_metadata %>%
    ggplot(aes(x = PC1, y = PC2)) +
    geom_point(aes(color = {{ x }}, shape = {{ y }}), size = 3) +
    theme_bw(base_size = 12) +
    labs(
      x = paste0("PC1: ", round(var_explained[1] * 100, 1), "%"),
      y = paste0("PC2: ", round(var_explained[2] * 100, 1), "%")
    ) +
    theme(legend.position = "top")
}

# color by tissue and sex
plot_pca(tissue, sex)

# color by sample
plot_pca(sample_id)
# add legend so that sample number can be visualized
plot_pca(sample_id) +
  theme(legend.position = "none") +
  geom_text(
    label = pca_metadata$sample_id,
    nudge_x = 0.25, nudge_y = 0.25,
    check_overlap = TRUE
  )

# color by batch
plot_pca(batch)

# color by rin score
plot_pca(RIN)

# color by median length
plot_pca(med_len)

# color by median quality
plot_pca(med_qual)

# color by total reads
plot_pca(total_reads)

# color by mouse id
plot_pca(mouse_id)
```
#### Clean up script

```{r tidy script}
style_file("pca_eda.Rmd")
lint("pca_eda.Rmd",
  linters = linters_with_defaults(
    object_length_linter = NULL,
    object_name_linter = NULL,
    object_usage_linter = NULL
  )
)
```

#### Software versions

```{r versions}
sessionInfo()
```
